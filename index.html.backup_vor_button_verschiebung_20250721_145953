<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sommerfest 2025 - Anmeldung</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background-color: #f5f7fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .main-content {
            flex: 1;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }

        .sidebar {
            width: 350px;
            background-color: #1e3a5f;
            color: white;
            padding: 30px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
        }

        .sidebar-left {
            background-color: #2c5282;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .simple-header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2c5282 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
            margin: -40px -40px 30px -40px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative;
        }

        .simple-header .main-title {
            color: white;
            font-size: 2.2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .simple-header .event-title {
            color: #a0c4ff;
            font-size: 1.8em;
            margin-bottom: 0;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        /* ORGA-LOGIN BUTTON */
        .orga-login-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(160, 196, 255, 0.2);
            color: #a0c4ff;
            padding: 8px 15px;
            border: 1px solid #a0c4ff;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            font-weight: bold;
        }

        .orga-login-button:hover {
            background: #a0c4ff;
            color: #1e3a5f;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        h1 {
            color: #1e3a5f;
            font-size: 2.5em;
            margin-bottom: 20px;
            font-weight: normal;
        }

        h2 {
            color: #2c5282;
            font-size: 1.8em;
            margin-bottom: 20px;
            font-weight: normal;
        }

        .welcome-text {
            background-color: #e6f2ff;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #2c5282;
            font-size: 1.15em;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            color: #1e3a5f;
            font-weight: bold;
            margin-bottom: 8px;
        }

        input[type="text"],
        input[type="email"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        textarea:focus {
            outline: none;
            border-color: #2c5282;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .button {
            background-color: #2c5282;
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .button:hover {
            background-color: #1e3a5f;
        }

        .button-secondary {
            background-color: #4a6fa5;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }

        .button-secondary:hover {
            background-color: #2c5282;
        }

        .sidebar h3 {
            font-size: 1.5em;
            margin-bottom: 20px;
            font-weight: normal;
            border-bottom: 2px solid #4a6fa5;
            padding-bottom: 10px;
        }

        .contribution-list {
            list-style: none;
        }

        .contribution-item {
            background-color: rgba(255,255,255,0.1);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 3px solid #4a6fa5;
        }

        .contribution-item strong {
            color: #a0c4ff;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }

        /* UX-VERBESSERUNG: Weiterleitungs-Overlay */
        .redirect-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 58, 95, 0.95);
            color: white;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            text-align: center;
            padding: 20px;
        }

        .redirect-content {
            background: rgba(255,255,255,0.1);
            padding: 40px;
            border-radius: 15px;
            border: 2px solid #a0c4ff;
            max-width: 500px;
            animation: pulse 2s infinite;
        }

        .redirect-content h3 {
            font-size: 2.2em;
            margin-bottom: 20px;
            color: #a0c4ff;
        }

        .redirect-content p {
            font-size: 1.3em;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .progress-bar {
            background-color: rgba(255,255,255,0.2);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #a0c4ff, #2c5282);
            height: 100%;
            width: 0%;
            animation: fillProgress 3s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes fillProgress {
            from { width: 0%; }
            to { width: 100%; }
        }

        /* UX-VERBESSERUNG: Warnung-Box für unvollständige Anmeldung */
        .warning-banner {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .warning-banner.show {
            display: block;
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Präferenzen-Sidebar Styles */
        .preferences-section {
            margin-bottom: 30px;
        }

        .preferences-section h4 {
            color: #a0c4ff;
            font-size: 1.3em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .preferences-category {
            margin-bottom: 20px;
        }

        .preferences-category h5 {
            color: #cbd5e0;
            font-size: 1.1em;
            margin-bottom: 10px;
            font-weight: normal;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #a0c4ff;
        }

        .checkbox-item label {
            color: white;
            font-weight: normal;
            margin-bottom: 0;
            cursor: pointer;
        }

        .preferences-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #4a6fa5;
            border-radius: 4px;
            background-color: rgba(255,255,255,0.1);
            color: white;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
            margin-top: 10px;
        }

        .preferences-textarea::placeholder {
            color: #cbd5e0;
        }

        .preferences-textarea:focus {
            outline: none;
            border-color: #a0c4ff;
            background-color: rgba(255,255,255,0.15);
        }

        /* Mobile Responsiveness */
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar,
            .sidebar-left {
                width: 100%;
                order: 2;
            }
            
            .main-content {
                order: 1;
            }

            .sidebar-left {
                order: 3;
            }
        }

        @media (max-width: 768px) {
            .sidebar,
            .sidebar-left {
                padding: 20px;
            }
            
            .main-content {
                padding: 20px;
            }

            .redirect-content {
                padding: 30px 20px;
            }

            .redirect-content h3 {
                font-size: 1.8em;
            }

            .redirect-content p {
                font-size: 1.1em;
            }

            .orga-login-button {
                position: relative;
                top: auto;
                right: auto;
                margin: 10px auto;
                display: block;
                text-align: center;
                width: fit-content;
            }
        }
    </style>
</head>
<body>
    <!-- UX-VERBESSERUNG: Warnung für unvollständige Anmeldung -->
    <div id="warningBanner" class="warning-banner">
        ⚠️ <strong>ACHTUNG:</strong> Ihre Anmeldung ist noch nicht abgeschlossen! Bitte füllen Sie alle Schritte aus.
    </div>

    <!-- UX-VERBESSERUNG: Weiterleitungs-Overlay -->
    <div id="redirectOverlay" class="redirect-overlay">
        <div class="redirect-content">
            <h3>🎉 Erster Schritt abgeschlossen!</h3>
            <p><strong>Sie werden zum nächsten Anmeldeschritt weitergeleitet...</strong></p>
            <p>Im nächsten Schritt können Sie sich als Helfer für Auf- und Abbau eintragen.</p>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
            <p style="font-size: 1em; color: #a0c4ff;">Bitte warten Sie einen Moment...</p>
        </div>
    </div>

    <div class="container">
        <!-- Grillbuffet-Präferenzen Sidebar (Links) -->
        <div class="sidebar sidebar-left">
            <div class="preferences-section">
                <h3>🍖 GRILLBUFFET-PRÄFERENZEN</h3>
                <p style="color: #cbd5e0; font-size: 0.9em; margin-bottom: 20px;">
                    Mehrfachauswahl möglich - hilft uns bei der Bestellplanung
                </p>
                
                <div class="preferences-category">
                    <h5>Wurst:</h5>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="wurst_schinkenwurst" value="Schinkenwurst">
                            <label for="wurst_schinkenwurst">Schinkenwurst</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="wurst_rostbratwurst" value="Rostbratwurst">
                            <label for="wurst_rostbratwurst">Rostbratwurst</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="wurst_gefluegelwurst" value="Geflügelwurst">
                            <label for="wurst_gefluegelwurst">Geflügelwurst</label>
                        </div>
                    </div>
                </div>

                <div class="preferences-category">
                    <h5>Fleisch:</h5>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="fleisch_haehnchenbrust" value="Hähnchenbrust">
                            <label for="fleisch_haehnchenbrust">Hähnchenbrust</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="fleisch_schweinenacken" value="Schweinenacken">
                            <label for="fleisch_schweinenacken">Schweinenacken</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="fleisch_putenbrust" value="Putenbrust">
                            <label for="fleisch_putenbrust">Putenbrust</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="fleisch_rind" value="Rind">
                            <label for="fleisch_rind">Rind</label>
                        </div>
                    </div>
                </div>

                <div class="preferences-category">
                    <h5>Vegetarisch/Vegan:</h5>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="veg_grillgemuese" value="Grillgemüse">
                            <label for="veg_grillgemuese">Grillgemüse</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="veg_vegane_bratwurst" value="Vegane Bratwurst">
                            <label for="veg_vegane_bratwurst">Vegane Bratwurst</label>
                        </div>
                    </div>
                </div>

                <textarea class="preferences-textarea" id="grillbuffet_bemerkungen" placeholder="Spezielle Wünsche zum Grillbuffet..."></textarea>
            </div>
        
            <div class="preferences-section">
                <h3>🍺 Getränke-Präferenzen</h3>
                <p style="color: #555; font-size: 0.9em; margin-bottom: 20px;">
                    Mehrfachauswahl möglich - hilft uns bei der Bestellplanung
                </p>
                
                <div class="preferences-category">
                    <h5>Softdrinks:</h5>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="soft_cola" value="Cola">
                            <label for="soft_cola">Cola</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="soft_fanta" value="Fanta">
                            <label for="soft_fanta">Fanta</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="soft_sprite" value="Sprite">
                            <label for="soft_sprite">Sprite</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="soft_wasser" value="Wasser">
                            <label for="soft_wasser">Wasser</label>
                        </div>
                    </div>
                </div>

                <div class="preferences-category">
                    <h5>Alkoholfrei:</h5>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="alkfrei_pils" value="Alkoholfreies Pils">
                            <label for="alkfrei_pils">Alkoholfreies Pils</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="alkfrei_weizen" value="Alkoholfreies Weizen">
                            <label for="alkfrei_weizen">Alkoholfreies Weizen</label>
                        </div>
                    </div>
                </div>

                <div class="preferences-category">
                    <h5>Bier:</h5>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="bier_pils" value="Pils">
                            <label for="bier_pils">Pils</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="bier_weizenbier" value="Weizenbier">
                            <label for="bier_weizenbier">Weizenbier</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="bier_weissbier" value="Weißbier">
                            <label for="bier_weissbier">Weißbier</label>
                        </div>
                    </div>
                </div>

                <div class="preferences-category">
                    <h5>Wein/Sekt:</h5>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="wein_rotwein" value="Rotwein">
                            <label for="wein_rotwein">Rotwein</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="wein_weisswein" value="Weißwein">
                            <label for="wein_weisswein">Weißwein</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="wein_prosecco" value="Prosecco">
                            <label for="wein_prosecco">Prosecco</label>
                        </div>
                    </div>
                </div>

                <div class="preferences-category">
                    <label for="getraenke_bemerkungen">Spezielle Wünsche zu den Getränken</label>
                    <textarea class="preferences-textarea" id="getraenke_bemerkungen" placeholder="z.B. Gerne auch alkoholfreies Bier..."></textarea>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="simple-header">
                <!-- ORGA-LOGIN BUTTON -->
                <a href="admin.html" class="orga-login-button" title="Für Organisatoren">
                    🔑 Orga-Team Login
                </a>
                
                <h1 class="main-title">Sommerfest der Lübecker Freimaurer</h1>
                <h2 class="event-title">Sommerfest 2025</h2>
            </div>
            
            <!-- NEUER WILLKOMMENSTEXT -->
            <div class="welcome-text">
                <p>Nach unserem grandiosen Sommerfest 2024 mit 120 Gästen freuen wir uns auch dieses Jahr wieder ein schönes Sommerfest zu gestalten. Wie gewohnt erwartet euch ein köstliches Grillbuffet mit Fleisch, Geflügel und vielen weiteren Leckereien für 18 Euro inklusive Eintritt. Dazu gestalten wir gemeinsam ein buntes Beilagenbuffet aus unserer aller Beiträgen.</p>
                <p>Bitte tragt links ein, was ihr euch für das Grillbuffet und für die Getränke wünscht (In der Handyansicht findet ihr die Listen im unteren Bereich). Mehrfachnennungen sind ausdrücklich erlaubt. Eure Angaben helfen uns dabei, die Bestellungen optimal zu planen.</p>
            </div>

            <div id="errorMessage" class="error-message">
                Bitte fülle alle Pflichtfelder aus.
            </div>

            <form id="registrationForm">
                <!-- ADRESSE HINZUGEFÜGT -->
                <h2>Deine Anmeldung zum Sommerfest am Samstag, den 23. August 2025 ab 18 Uhr<br>
                    <small style="font-size: 0.8em; color: #4a6fa5; font-weight: normal;">im Logenhaus Lübeck, St. Annen-Str. / Ecke Schildstraße - Eingang Hoftor</small>
                </h2>
                
                <div class="form-group">
                    <!-- "IHR NAME" → "NAME" GEÄNDERT -->
                    <label for="name">Name *</label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div class="form-group">
                    <label for="email">E-Mail-Adresse *</label>
                    <input type="email" id="email" name="email" required>
                </div>

                <div class="form-group">
                    <label for="lodge">Logenzugehörigkeit</label>
                    <input type="text" id="lodge" name="lodge">
                </div>

                <div class="form-group">
                    <label for="companions">Begleitung (Namen, durch Komma getrennt)</label>
                    <input type="text" id="companions" name="companions" placeholder="z.B. Max Mustermann, Erika Musterfrau">
                </div>

                <h2>Dein/Euer Beitrag zum Buffet</h2>
                
                <div class="form-group">
                    <label for="contribution">Was möchtest du mitbringen? *</label>
                    <input type="text" id="contribution" name="contribution" required placeholder="z.B. Kartoffelsalat">
                </div>

                <div class="form-group">
                    <label for="quantity">Menge/Anzahl *</label>
                    <input type="text" id="quantity" name="quantity" required placeholder="z.B. für 10 Personen">
                </div>

                <button type="button" id="add-buffet-item" class="button-secondary" onclick="addBuffetItem()">+ Weiteren Beitrag hinzufügen</button>
                
                <!-- UX-VERBESSERUNG: Neuer Button-Text -->
                <button type="submit" class="button">➡️ Weiter zum nächsten Schritt</button>
            </form>
        </div>

        <!-- Vereinfachte Buffet-Sidebar (Rechts) -->
        <div class="sidebar">
            <h3>Bisherige Buffet-Beiträge</h3>
            <ul id="contributionsList" class="contribution-list">
            </ul>
        </div>
    </div>

    <script>
        // UX-VERBESSERUNG: Warnung bei Seitenverlassen ohne Abschluss
        let anmeldungBegonnen = false;
        let anmeldungAbgeschlossen = false;

        // Überwachung ob User das Formular zu füllen beginnt
        document.addEventListener('DOMContentLoaded', function() {
            const formInputs = document.querySelectorAll('#registrationForm input, #registrationForm textarea');
            formInputs.forEach(input => {
                input.addEventListener('input', function() {
                    if (!anmeldungBegonnen) {
                        anmeldungBegonnen = true;
                        // Warnung bei Seitenverlassen aktivieren
                        window.addEventListener('beforeunload', function(e) {
                            if (anmeldungBegonnen && !anmeldungAbgeschlossen) {
                                e.preventDefault();
                                e.returnValue = 'Ihre Anmeldung ist noch nicht abgeschlossen. Möchten Sie die Seite wirklich verlassen?';
                                return e.returnValue;
                            }
                        });
                    }
                });
            });
        });

        // Simulierte Datenbank für Beiträge
        let contributions = [];

        // Funktion zum Aktualisieren der Beitragsliste
        function updateContributionsList() {
            const list = document.getElementById('contributionsList');
            list.innerHTML = '';
            
            contributions.forEach(contribution => {
                const li = document.createElement('li');
                li.className = 'contribution-item';
                li.innerHTML = `
                    <strong>${contribution.item}</strong><br>
                    Menge: ${contribution.quantity}
                `;
                list.appendChild(li);
            });
        }

        // n8n Webhook URL
        const N8N_WEBHOOK_URL = 'https://automatisierung.frankrath.de/webhook/sommerfest-anmeldung';

        // Gäste-Zahlen-Berechnung
        function calculateGuestNumbers(companions) {
            if (!companions || companions.trim() === '') {
                return {
                    anzahlGaeste: 0,
                    gesamtPersonen: 1
                };
            }
            
            const guestList = companions.split(',')
                .map(name => name.trim())
                .filter(name => name.length > 0);
            
            const anzahlGaeste = guestList.length;
            const gesamtPersonen = 1 + anzahlGaeste;
            
            return {
                anzahlGaeste: anzahlGaeste,
                gesamtPersonen: gesamtPersonen
            };
        }

        // Neue Funktion: Präferenzen sammeln
        function collectPreferences() {
            const grillbuffetPrefs = [];
            const getraenkePrefs = [];
            
            // Grillbuffet-Präferenzen sammeln
            const grillbuffetCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="wurst_"], input[type="checkbox"][id^="fleisch_"], input[type="checkbox"][id^="veg_"]');
            grillbuffetCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    grillbuffetPrefs.push(checkbox.value);
                }
            });
            
            // Getränke-Präferenzen sammeln
            const getraenkeCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="soft_"], input[type="checkbox"][id^="alkfrei_"], input[type="checkbox"][id^="bier_"], input[type="checkbox"][id^="wein_"]');
            getraenkeCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    getraenkePrefs.push(checkbox.value);
                }
            });
            
            return {
                grillbuffet: grillbuffetPrefs,
                grillbuffet_bemerkungen: document.getElementById('grillbuffet_bemerkungen').value,
                getraenke: getraenkePrefs,
                getraenke_bemerkungen: document.getElementById('getraenke_bemerkungen').value
            };
        }

        let buffetItemCount = 1;

        function addBuffetItem() {
            buffetItemCount++;
            const container = document.getElementById("quantity").parentNode;
            const newItem = document.createElement("div");
            newItem.className = "form-group";
            newItem.innerHTML = `
                <label for="contribution${buffetItemCount}">Weiterer Beitrag ${buffetItemCount} *</label>
                <input type="text" id="contribution${buffetItemCount}" name="contribution${buffetItemCount}" required placeholder="z.B. Kartoffelsalat">
                <label for="quantity${buffetItemCount}">Menge/Anzahl *</label>
                <input type="text" id="quantity${buffetItemCount}" name="quantity${buffetItemCount}" required placeholder="z.B. für 10 Personen">
                <button type="button" onclick="removeBuffetItem(this)" class="button-secondary">Entfernen</button>
            `;
            container.parentNode.insertBefore(newItem, container.nextSibling);
        }
        
        function removeBuffetItem(button) {
            button.parentNode.remove();
        }

        // Funktion zum Sammeln aller Buffet-Beiträge
        function collectAllBuffetItems() {
            const buffetItems = [];
            
            // Hauptbeitrag
            const mainItem = document.getElementById("contribution").value;
            const mainQuantity = document.getElementById("quantity").value;
            if (mainItem && mainQuantity) {
                buffetItems.push({ item: mainItem, quantity: mainQuantity });
            }
            
            // Zusätzliche Beiträge
            for (let i = 2; i <= buffetItemCount; i++) {
                const itemElement = document.getElementById(`contribution${i}`);
                const quantityElement = document.getElementById(`quantity${i}`);
                if (itemElement && quantityElement && itemElement.value && quantityElement.value) {
                    buffetItems.push({ item: itemElement.value, quantity: quantityElement.value });
                }
            }
            
            return JSON.stringify(buffetItems);
        }

        // UX-VERBESSERUNG: Erweiterte Formular-Submit Handler
        document.getElementById('registrationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Button sofort deaktivieren
            const submitButton = document.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.disabled = true;
            submitButton.textContent = "⏳ Wird verarbeitet...";
            submitButton.style.backgroundColor = "#6c757d";
            submitButton.style.cursor = "not-allowed";
            
            // Formulardaten sammeln (inkl. Präferenzen)
            const preferences = collectPreferences();
            
            const formData = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                lodge: document.getElementById('lodge').value,
                companions: document.getElementById('companions').value,
                contribution: collectAllBuffetItems(),
                quantity: "Siehe Buffet-Details",
                // Neue Präferenzen-Felder
                grillbuffet_praeferenzen: JSON.stringify(preferences.grillbuffet),
                grillbuffet_bemerkungen: preferences.grillbuffet_bemerkungen,
                getraenke_praeferenzen: JSON.stringify(preferences.getraenke),
                getraenke_bemerkungen: preferences.getraenke_bemerkungen
            };

            // Validierung
            const buffetData = JSON.parse(formData.contribution);
            if (!formData.name || !formData.email || buffetData.length === 0) {
                // Button wieder aktivieren bei Fehler
                submitButton.disabled = false;
                submitButton.textContent = originalText;
                submitButton.style.backgroundColor = "#2c5282";
                submitButton.style.cursor = "pointer";
                
                document.getElementById("errorMessage").textContent = "Bitte fülle alle Pflichtfelder aus.";
                document.getElementById("errorMessage").style.display = "block";
                return;
            }

            // DOPPELEINTRAG-FIX: Nur Datensammlung, KEIN n8n-Request
            // n8n-Request erfolgt erst auf helfer.html mit allen Daten
            console.log('Daten für Weiterleitung vorbereitet (mit Präferenzen):', formData);
            
            // Neue Beiträge zur lokalen Liste hinzufügen (optional)
            const buffetItems = JSON.parse(formData.contribution);
            buffetItems.forEach(item => {
                contributions.push({
                    item: item.item,
                    quantity: item.quantity
                });
            });
            updateContributionsList();

            // Error-Message ausblenden
            document.getElementById('errorMessage').style.display = 'none';
            
            // UX-VERBESSERUNG: Großes Weiterleitungs-Overlay anzeigen
            document.getElementById('redirectOverlay').style.display = 'flex';
            
            // Button-Text ändern
            submitButton.textContent = "✅ Erfolgreich! Weiterleitung läuft...";

            // Formular zurücksetzen
            this.reset();
            
            // Präferenzen-Checkboxen zurücksetzen
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Dynamische Buffet-Felder zurücksetzen
            const dynamicItems = document.querySelectorAll("[id^='contribution']:not([id='contribution']), [id^='quantity']:not([id='quantity'])");
            dynamicItems.forEach(item => item.parentNode.remove());
            buffetItemCount = 1;
            
            // UX-VERBESSERUNG: Längere Wartezeit für bessere UX (3 Sekunden für Overlay-Anzeige)
            setTimeout(() => {
                anmeldungAbgeschlossen = true; // Warnung bei Seitenverlassen deaktivieren
                
                const guestNumbers = calculateGuestNumbers(formData.companions);
                const helferParams = new URLSearchParams({
                    name: formData.name,
                    email: formData.email,
                    loge: formData.lodge,
                    gaesteNamen: formData.companions,
                    buffet: formData.contribution,
                    portionen: formData.quantity,
                    anzahlGaeste: guestNumbers.anzahlGaeste.toString(),
                    gesamtPersonen: guestNumbers.gesamtPersonen.toString(),
                    timestamp: new Date().toISOString(),
                    // Neue Präferenzen-Parameter
                    grillbuffet_praeferenzen: formData.grillbuffet_praeferenzen,
                    grillbuffet_bemerkungen: formData.grillbuffet_bemerkungen,
                    getraenke_praeferenzen: formData.getraenke_praeferenzen,
                    getraenke_bemerkungen: formData.getraenke_bemerkungen
                });
                window.location.href = `helfer.html?${helferParams.toString()}`;
            }, 3000);
        });

        async function loadLiveBuffetData() {
            try {
                const response = await fetch("https://automatisierung.frankrath.de/webhook/buffet-uebersicht");
                const data = await response.json();
                
                const liveList = document.getElementById("contributionsList");
                if (liveList) {
                    liveList.innerHTML = "";
                } else {
                    console.log("contributionsList Element nicht gefunden");
                    return;
                }
                
                Object.entries(data).sort(([a], [b]) => a.localeCompare(b)).forEach(([item, quantity]) => {
                    const listItem = document.createElement("li");
                    listItem.className = "contribution-item";
                    listItem.innerHTML = `<strong>${item}</strong><br>Menge: ${quantity}`;
                    liveList.appendChild(listItem);
                });
            } catch (error) {
                console.error('Fehler beim Laden der Live-Daten:', error);
            }
        }

        async function loadHelferStatistik() {
            try {
                const response = await fetch("https://automatisierung.frankrath.de/webhook/helfer-statistik");
                const data = await response.json();
                
                const aufbauElement = document.getElementById("aufbau-count");
                const abbauElement = document.getElementById("abbau-count");
                if (aufbauElement) aufbauElement.textContent = data.aufbau || "0";
                if (abbauElement) abbauElement.textContent = data.abbau || "0";
            } catch (error) {
                console.error('Fehler beim Laden der Helfer-Statistik:', error);
            }
        }

        // Live-Daten alle 30 Sekunden laden
        setInterval(loadLiveBuffetData, 30000);
        setInterval(loadHelferStatistik, 30000);
        loadLiveBuffetData(); // Erste Ladung

        // UX-VERBESSERUNG: Warnung-Banner anzeigen bei bestimmten Szenarien
        function showWarningIfIncomplete() {
            if (anmeldungBegonnen && !anmeldungAbgeschlossen) {
                const banner = document.getElementById('warningBanner');
                banner.classList.add('show');
                setTimeout(() => {
                    banner.classList.remove('show');
                }, 5000);
            }
        }

        // Warnung anzeigen wenn User scrollt aber nicht abschließt
        let hasScrolled = false;
        window.addEventListener('scroll', function() {
            if (!hasScrolled && anmeldungBegonnen && !anmeldungAbgeschlossen) {
                hasScrolled = true;
                setTimeout(showWarningIfIncomplete, 2000);
            }
        });
    </script>
</body>
</html>
